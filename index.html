<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#000000" />
  <title>Sales Tax</title>
  <!-- iOS: open fullscreen when added to Home Screen -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Sales Tax">
  <style>
    :root{
      /* Pure black AMOLED theme */
      --bg:#000000;
      --ink:#ffffff;
      --muted:rgba(255,255,255,.80);
      --card:rgba(255,255,255,.05);
      --card-border:rgba(255,255,255,.14);
      --input-bg:rgba(255,255,255,.10);
      --input-border:rgba(255,255,255,.26);
      --chip-border:rgba(255,255,255,.26);
      --ok:#16a34a; /* green */
      --danger:#ef4444; /* red */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg);
      color:var(--ink);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      padding-left:env(safe-area-inset-left);padding-right:env(safe-area-inset-right);padding-bottom:env(safe-area-inset-bottom);
    }
    .wrap{max-width:620px;margin:0 auto;padding:16px 18px 24px}
    header{display:grid;grid-template-columns:1fr auto;align-items:center;padding:10px 0 6px}
    h1{font-size:22px;margin:0;font-weight:800;letter-spacing:.2px}
    .card{background:var(--card);border:1px solid var(--card-border);backdrop-filter:saturate(1.05) blur(2px);border-radius:20px;padding:14px 14px;margin-top:12px}
    .row{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;padding:10px;border-radius:14px}
    .row + .row{margin-top:6px}
    label{font-size:16px;color:var(--muted)}

    /* Inputs: use text with decimal keypad for iOS */
    input[type="text"]{width:180px;border:1px solid var(--input-border);outline:none;border-radius:14px;padding:12px 14px;font-size:18px;font-weight:800;background:var(--input-bg);color:var(--ink)}
    input.small{width:120px;font-size:16px;font-weight:700}

    .muted{color:var(--muted)}
    .total{font-size:44px;font-weight:900;letter-spacing:0.3px;margin:6px 0 4px}
    .subtle{font-size:14px;color:var(--muted)}

    .btn{appearance:none;border:1px solid var(--chip-border);background:rgba(255,255,255,.10);color:#fff;border-radius:12px;padding:10px 12px;font-weight:800;box-shadow:0 2px 10px rgba(0,0,0,.5)}
    .btn:active{transform:translateY(1px)}
    .btn.clear{background:rgba(239,68,68,.18);border-color:rgba(239,68,68,.55)}

    .inline{display:inline-flex;gap:10px;align-items:center}
    .right{justify-self:end}
    .switch{display:inline-flex;align-items:center;gap:8px;font-size:13px;color:var(--muted)}
    .switch input{accent-color:var(--ok)}
    .chips{display:flex;flex-wrap:wrap;gap:8px;justify-content:flex-end}
    .chipbtn{border:1px solid var(--chip-border);background:rgba(255,255,255,.08);border-radius:999px;padding:6px 10px;font-weight:900;font-size:14px;color:#fff}
    .chipbtn:hover{filter:brightness(1.1)}
    .chipbtn:active{transform:translateY(1px);filter:brightness(0.96)}
    :focus-visible{outline:3px solid rgba(255,255,255,.55);outline-offset:2px;border-radius:10px}

    @media (prefers-color-scheme: light){
      /* Keep a clean light fallback (not AMOLED) */
      :root{--ink:#0b1a33;--muted:rgba(11,26,51,.65);--card:rgba(255,255,255,.96);--card-border:rgba(0,0,0,.08);--input-bg:#ffffff;--input-border:rgba(0,0,0,.12);--chip-border:rgba(0,0,0,.15)}
      body{background:#f6f9ff}
      .chipbtn{background:#fff;color:#0b1a33}
      .btn{background:#ffffff;color:#0b1a33;border:1px solid rgba(0,0,0,.12)}
      .btn.clear{background:#fff;color:#b91c1c;border-color:#ef4444}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Sales Tax</h1>
      <button class="btn clear" id="clearBtn" aria-label="Clear all">Clear</button>
    </header>

    <section class="card" aria-label="Inputs">
      <div class="row">
        <label for="price">Price (CAD)</label>
        <input id="price" type="text" inputmode="decimal" enterkeyhint="done" placeholder="0.00" autocomplete="off" autocorrect="off" spellcheck="false">
      </div>
      <div class="row">
        <label for="sale">Sale % (optional)</label>
        <input id="sale" class="small" type="text" inputmode="decimal" enterkeyhint="next" placeholder="0" autocomplete="off" autocorrect="off" spellcheck="false">
      </div>
      <div class="row">
        <label for="hst">HST (Ontario)</label>
        <div class="inline right">
          <input id="hst" class="small" type="text" inputmode="decimal" enterkeyhint="done" value="13" aria-label="HST percent" autocomplete="off" autocorrect="off" spellcheck="false">
          <span class="muted">%</span>
        </div>
      </div>
      <div class="row">
        <label for="tip">Tip % (optional)</label>
        <div class="inline right">
          <input id="tip" class="small" type="text" inputmode="decimal" enterkeyhint="done" placeholder="0" autocomplete="off" autocorrect="off" spellcheck="false">
          <span class="muted">%</span>
        </div>
      </div>
      <div class="row" style="padding-top:0">
        <label class="muted">Quick tip</label>
        <div class="chips right" aria-label="Quick tip buttons">
          <button type="button" class="chipbtn" data-tip="5">5%</button>
          <button type="button" class="chipbtn" data-tip="10">10%</button>
          <button type="button" class="chipbtn" data-tip="12">12%</button>
          <button type="button" class="chipbtn" data-tip="15">15%</button>
        </div>
      </div>
      <div class="row" style="padding-top:0">
        <label class="muted">Tip calculation</label>
        <div class="right switch">
          <input type="checkbox" id="tipAfterTax"> <label for="tipAfterTax">After tax</label>
        </div>
      </div>
    </section>

    <section class="card" aria-label="Results">
      <div class="row">
        <label>Discounted Subtotal</label>
        <div class="right" id="subtotalCAD">$0.00</div>
      </div>
      <div class="row">
        <label>HST Amount</label>
        <div class="right" id="taxCAD">$0.00</div>
      </div>
      <div class="row">
        <label class="muted">Total w/ HST (no tip)</label>
        <div class="right" id="totalCAD">$0.00</div>
      </div>
      <div class="row">
        <label>Tip Amount</label>
        <div class="right" id="tipCAD">$0.00</div>
      </div>
      <div class="row">
        <label class="muted">Grand Total (incl. tip)</label>
        <div class="total right" id="grandCAD">$0.00</div>
      </div>
      <div class="row" style="padding-top:0">
        <label class="muted">Grand Total (INR)</label>
        <div class="right" id="totalINR" style="font-weight:800">â‚¹0</div>
      </div>
      <div class="subtle" id="rateNote">Using 1 CAD = <span id="rateDisplay">62.00</span> INR</div>
    </section>

    <section class="card" aria-label="INR rate">
      <div class="grid2" style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div>
          <label for="rate" class="muted">INR per CAD</label>
          <input id="rate" class="small" type="text" inputmode="decimal" enterkeyhint="done" value="62.00" autocomplete="off" autocorrect="off" spellcheck="false">
        </div>
        <div class="right inline" style="gap:8px;justify-self:end">
          <button class="btn" id="saveRate">Save rate</button>
          <button class="btn" id="fetchRate">Fetch latest</button>
        </div>
      </div>
    </section>

    <!-- Footer removed per request (no install hint line) -->
  </div>

  <script>
    // --- Utility formatters ---
    const fmtCAD = new Intl.NumberFormat('en-CA',{style:'currency', currency:'CAD'});
    const fmtINR = new Intl.NumberFormat('en-IN',{style:'currency', currency:'INR', maximumFractionDigits:0});

    const $ = sel => document.querySelector(sel);
    const priceEl = $('#price');
    const saleEl = $('#sale');
    const hstEl = $('#hst');
    const rateEl = $('#rate');
    const tipEl = $('#tip');
    const tipAfterTaxEl = $('#tipAfterTax');

    const subtotalEl = $('#subtotalCAD');
    const taxEl = $('#taxCAD');
    const totalCADEl = $('#totalCAD');
    const tipCADEl = $('#tipCAD');
    const grandCADEl = $('#grandCAD');
    const totalINREl = $('#totalINR');
    const rateDisplayEl = $('#rateDisplay');

    // Load saved state
    const SAVED = JSON.parse(localStorage.getItem('hstpwa:state')||'{}');
    if(SAVED.rate) rateEl.value = String(SAVED.rate);
    if(SAVED.hst) hstEl.value = String(SAVED.hst);
    if(SAVED.tipAfterTax) tipAfterTaxEl.checked = true;

    function persist(){
      localStorage.setItem('hstpwa:state', JSON.stringify({
        rate: Number(rateEl.value)||62,
        hst: Number(hstEl.value)||13,
        tipAfterTax: !!tipAfterTaxEl.checked
      }));
    }

    function toNumber(val){
      const n = Number(String(val).replace(/[^0-9.\-]/g,''));
      return Number.isFinite(n) ? n : 0;
    }

    function calc(){
      const price = toNumber(priceEl.value);
      const salePct = toNumber(saleEl.value);
      const hstPct = toNumber(hstEl.value) || 13;
      const rate = toNumber(rateEl.value) || 62;
      const tipPct = toNumber(tipEl.value);
      const tipOnAfterTax = !!tipAfterTaxEl.checked;

      const discounted = price * (1 - (salePct/100));
      const tax = discounted * (hstPct/100);
      const totalNoTip = discounted + tax;

      const tipBase = tipOnAfterTax ? totalNoTip : discounted; // default: pre-tax
      const tipAmt = tipBase * (tipPct/100);
      const grand = totalNoTip + tipAmt;

      subtotalEl.textContent = fmtCAD.format(discounted || 0);
      taxEl.textContent = fmtCAD.format(tax || 0);
      totalCADEl.textContent = fmtCAD.format(totalNoTip || 0);
      tipCADEl.textContent = fmtCAD.format(tipAmt || 0);
      totalINREl.textContent = fmtINR.format((grand || 0) * rate);
      grandCADEl.textContent = fmtCAD.format(grand || 0);
      rateDisplayEl.textContent = (rate || 0).toFixed(2);
    }

    ['input','change'].forEach(evt=>{
      [priceEl,saleEl,hstEl,rateEl,tipEl,tipAfterTaxEl].forEach(el=> el.addEventListener(evt,()=>{ if(el===rateEl||el===hstEl||el===tipAfterTaxEl) persist(); calc(); }));
    });

    // Quick tip buttons
    document.querySelectorAll('[data-tip]').forEach(btn=>{
      btn.addEventListener('click',()=>{ tipEl.value = btn.dataset.tip; calc(); });
    });

    // Clear
    $('#clearBtn').addEventListener('click',()=>{priceEl.value=''; saleEl.value=''; tipEl.value=''; calc(); safeFocus();});

    $('#saveRate').addEventListener('click',()=>{ persist(); calc(); navigator.vibrate?.(8);});

    $('#fetchRate').addEventListener('click', async ()=>{
      const btn = $('#fetchRate');
      const original = btn.textContent; btn.textContent='Fetchingâ€¦'; btn.disabled=true;
      try{
        const res = await fetch('https://open.er-api.com/v6/latest/CAD', {cache:'no-store'});
        const data = await res.json();
        if(data && data.result==='success' && data.rates && data.rates.INR){
          rateEl.value = String(Number(data.rates.INR).toFixed(2));
          persist(); calc();
        } else { alert('Could not get a rate; set it manually.'); }
      }catch(e){ alert('Network error; set the INR rate manually.'); }
      finally{ btn.textContent=original; btn.disabled=false; }
    });

    // Auto-focus behaviour (bestâ€‘effort on iOS)
    function safeFocus(){ priceEl.focus(); try{ priceEl.setSelectionRange(0, priceEl.value.length); }catch(_){} }
    window.addEventListener('pageshow', ()=> setTimeout(safeFocus, 50));
    document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') setTimeout(safeFocus, 50); });
    document.addEventListener('touchstart', function onFirstTouch(){ safeFocus(); document.removeEventListener('touchstart', onFirstTouch); }, {passive:true});

    // First paint
    calc();

    // --- Manifest via Blob (single-file app) ---
    (function initManifest(){
      const manifest = {
        name: 'Sales Tax',
        short_name: 'Sales Tax',
        description: 'Ad-free Sales Tax calculator for Ontario with INR total + optional tip.',
        start_url: '.',
        display: 'standalone',
        background_color: '#000000',
        theme_color: '#000000',
        icons: []
      };
      // Simple icon: red square with white dollar sign
      function makeDollarIcon(size){
        const c=document.createElement('canvas'); c.width=c.height=size; const x=c.getContext('2d');
        x.fillStyle='#d32f2f'; x.fillRect(0,0,size,size);
        x.fillStyle='#ffffff'; x.textAlign='center'; x.textBaseline='middle';
        x.font = `bold ${Math.round(size*0.62)}px system-ui, -apple-system, Arial, sans-serif`;
        x.fillText('$', size/2, Math.round(size*0.58));
        return c.toDataURL('image/png');
      }
      manifest.icons = [192,256,384,512].map(s => ({ src: makeDollarIcon(s), sizes: `${s}x${s}`, type: 'image/png' }));

      const blob = new Blob([JSON.stringify(manifest)], {type:'application/manifest+json'});
      const url = URL.createObjectURL(blob);
      const link = document.createElement('link');
      link.rel = 'manifest'; link.href = url; document.head.appendChild(link);

      const appleIcon = document.createElement('link');
      appleIcon.rel='apple-touch-icon'; appleIcon.href=makeDollarIcon(180);
      document.head.appendChild(appleIcon);
    })();

    // --- Service Worker via Blob (cache this single page for fast startup/offline) ---
    if('serviceWorker' in navigator){
      const swCode = `
        const CACHE='salestax-pwa-v6';
        self.addEventListener('install', e=>{
          e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['./'])));
          self.skipWaiting();
        });
        self.addEventListener('activate', e=>{ e.waitUntil(self.clients.claim()); });
        self.addEventListener('fetch', e=>{
          const req = e.request;
          if(req.method!=='GET') return;
          e.respondWith(
            caches.match(req).then(hit=> hit || fetch(req).then(res=>{
              if(new URL(req.url).origin===location.origin){
                const copy = res.clone(); caches.open(CACHE).then(c=>c.put(req, copy));
              }
              return res;
            }).catch(()=> caches.match('./')))
          );
        });`;
      const swUrl = URL.createObjectURL(new Blob([swCode], {type:'text/javascript'}));
      navigator.serviceWorker.register(swUrl).catch(()=>{});
    }
  </script>
</body>
</html>
